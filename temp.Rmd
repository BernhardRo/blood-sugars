---
title: "Basic CGM Statistics - Introduction"
author: "Andy Choens"
output: md_document

---

# Objectives

When Karen meets with her endocrinologist, they look at a Medtronic
report titled "Sensor & Meter Overview". The report I am using as my
canonical example is a five page report which contains a "Statistics"
table on page two. An example of this table is provided below. This
table contains basic descriptive statistics from manual blood glucose
tests and CGM readings. Today, we will use Nightscout CGM data to
replicate and extend the information shown in the "Statistics" table.

The objectives of today's post are:

1. Import CGM data from a CSV file.
2. Clean-Up / Process the data (Data Munging!) to prepare it for use.
3. Use R to produce descriptive tables which are similar to three of
   the data elements provided in the Medtronic Statistics table shown
   below.

   - The Medtronic table provides descriptive statistics for a single
     time period. The demo code provided here returns descriptive
     statistics from four weeks this summer. This allows us to
     understand if values from any given week are an aberration or are
     normal for Karen.
   - We will only use Nightscout CGM data. The Statistics table uses
     data from a Medtronic CGM, manual blood glucose tests and
     information entered into and recorded by a Medtronic insulin
     pump. Some of the calculations shown here are not direct
     equivalents of the data shown in the Statistics table. Several
     data elements from the example table will be skipped entirely.

4. Learn more about Karen's blood average blood glucose levels and use
   this to discuss the broader goals of this project.

All code will be shown and documented.

# Code, Data, Dependencies

*Code:* The .Rmd file used to create this post is available on
[GitHub](https://github.com/Choens/blood-sugars/blob/master/2015-08-16-basic-statistics.Rmd).

*Data Location:* The data used here can be found in the
[data sub-folder](https://github.com/Choens/blood-sugars/tree/master/data)
on the project page.

*Data Warning:* Our current rig has been in nearly continuous use
since June 21, 2015.  Data collected prior to June 2015 is
inconsistent due to limitations with the previous rig and mistakes we
made figuring out how to use it. I do not recommend using data
collected prior to June 2015 for analysis.

*Reproducibility Warning:* File names and content are subject to
periodic updates. Open a bug or download the repository from GitHub
for long-term use.

The only dependencies needed to run the code in this document are
dplyr and ggplot2 from the
[Hadleyverse](https://en.wikipedia.org/wiki/Hadley_Wickham) and pander
which produces the formatted table output. To compile the HTML from
the .Rmd file you will also need the rmarkdown package.

```{r init, echo=TRUE, message=FALSE}

## Dependencies ----------------------------------------------------------------
## If any of these fail, run the following (capitalization counts):
## install.packages("name_of_package")
library(dplyr)
library(ggplot2)
library(pander)

## Config ----------------------------------------------------------------------

## Prevents pander from wrapping the table @ 80 chars.
panderOptions('table.split.table', Inf)

```

# Data Import & Munging

The following code chunk imports the most recent CSV file available in
the data folder and stores it in a data frame called "entries". This
name was chosen for consistency with Nightscout naming conventions.

```{r import-data, echo=TRUE}

## Import data------------------------------------------------------------------
## Retrieves a list of CSV files in the data dir.
## Imports the most recent file, assuming the file naming schema is followed.
files <- dir("data", "*csv", full.names=TRUE)
entries <- read.csv(files[length(files)], as.is=TRUE)

## Data Munging ----------------------------------------------------------------

## Removes unnecessary SGV rows.
entries <- entries %>%
    filter(type == "sgv")

## Tells R the "date" column is full of dates.
entries$date <- as.POSIXct(entries$date)

## Week Labels - Useful labels we will be to aggregate by later.
entries$wk_lbl <- NA
entries$wk_lbl[ entries$date >= '2015-06-28' & entries$date <'2015-07-05' ] <- 'Week 1: June 28 - July 04'
entries$wk_lbl[ entries$date >= '2015-07-05' & entries$date <'2015-07-12' ] <- 'Week 2: July 05 - July 11'
entries$wk_lbl[ entries$date >= '2015-07-12' & entries$date <'2015-07-19' ] <- 'Week 3: July 12 - July 18'
entries$wk_lbl[ entries$date >= '2015-07-19' & entries$date <'2015-07-26' ] <- 'Week 4: July 19 - July 25'

```

Nightscout data is a time-series data set. The descriptive statistics
shown below aggregates CGM readings by week. The "Week Labels" column
(wk\_lbl) is a simple way to aggregate and label the data. Future
posts will demonstrate how to graph individual CGM readings to look
for patterns.

# Descriptive Statistics

The "Statistics" table from the Medtronic report contains 12 rows of
data. The table shown below is a report from this winter showing data
from February 13 - 26, 2015. It only shows the first seven rows of the
table because the others are not directly related to blood glucose
data.

Karen's CGM is made by a company called Dexcom. Her pump is made by a
competitor, Medtronic, which is the source of the statistical report
shown below. Because it is beyond humanity's technological capacity to
build a common data interface across device brands, the two devices
cannot communicate with one another. Data elements based on CGM data
are blank because the Medtronic system cannot get data from a Dexcom
CGM. Humanity was able to land on the moon with a computer that is
less powerful than the chip in my new
[Pebble Watch](https://getpebble.com/), but device interoperability
continues to elude us. Although the missing numbers are regrettable,
the Statistics table is a useful template that shows us what data
elements doctors find useful when reviewing a patient's recent
blood glucose control.

<a href="/home/andy/Git/blood-sugars/images/2015-08-16/01-statistics.jpg">
<img
src="/home/andy/Git/blood-sugars/images/2015-08-16/01-statistics.jpg" width="329" height="478">
</a>

Today's efforts will focus on using Nightscout CGM data to produce
tables which are clinically similar to the averages shown above. The
following table describes the data elements in the Statistics table
that are relevant for today's discussion. The first four rows of the
Statistics table are based on manual blood glucose tests, not CGM
data. Only data elements that are based on CGM data can be directly
replicated using the Nightscout data. It is however, possible to use
Nightscout data to estimate the other data elements, with some caveats
because of the differences in measurement and accuracy. The
differences between these two methods for measuring blood glucose
levels will be discussed in greater detail later this week.

 Data Element   Statistics Table       Data Source                          Replicated   Data Element Description
--------------  ---------------------  ------------                        ------------  ---------------------
 1              Avg BG (mg/dL)         Manual Blood Glucose Test           No            Average blood glucose levels and standard deviation
 2              BG Readings            Manual Blood Glucose Test           No            Number of manual tests during measurement period and the average number of manual tests per a day
 3              Readings Above Target  Manual Blood Glucose Test           Yes           Number and proportion of CGM readings above 140 mg/dL
 4              Readings Below Target  Manual Blood Glucose Test           Yes           Number and proportion of CGM readings below 70 mg/dL
 5              Sensor Avg (mg/dL)     Continuous Glucose Monitor Reading  Yes           Average CGM reading during the measurement period
 6              Avg AUC > 140 (mg/dL)  Continuous Glucose Monitor Reading  No            Average Area Under Curve (AUC) for readings over 140 mg/dL
 7              Avg AUC < 70 (mg/dL)   Continuous Glucose Monitor Reading  No            Average Area Under Curve (AUC) for readings under 70 mg/dL

The goal of every Type 1 diabetic is to use insulin, diet, activity
and monitoring to artificially maintain blood glucose homeostasis. The
desired outcome of these efforts is a blood glucose level between 70
and 140 mg/dL. Readings below 70 mg/dL are indicative of hypoglycemia
or "lows" which must be treated by consuming sugar to raise the blood
glucose level. Readings above 140 mg/dL are indicative of
hyperglycemia or "highs" which must be treated by injecting
insulin. High blood sugar levels damage the body and lead to
complications such as nerve damage.

How much damage is a function of both the severity and the duration of
the hyperglycemic event. Brief but extreme spikes in blood-sugar can
actually be less damaging to Karen's body that extended periods of
moderately high blood glucose levels. This is why the Medtronic report
includes the Average Area Under The Curve (AUC) which controls for
both the severity and duration of hyperglycemia. Unfortunately, there
are competing methods for calculating the Average AUC. As a result of
this complexity, Average AUC will be discussed in a separate post. Today's
post focuses on the other three data elements derived from CGM sensor
data (rows 3-5).

# Sensor Avg (mg/dL)

The table shown below is similar to the "Sensor Avg" data element on
row five. Had the data been available, the Medtronic report would have
shown a two week average sensor reading. While useful, it lacks
context. I also want to understand the stability of this average over
time. Is an average of 187 mg/dL normal or abnormal for Karen?
Fortunately, our public Nightscout data set is large enough to return
multiple weekly averages, which can put any single week's average into
a broader context. The following table includes four weekly sensor
averages and we can see that Karen's weekly averages and standard
deviations are fairly consistent week to week.

```{r avg-bg, echo=TRUE}

entries %>%
    filter( !is.na(wk_lbl) ) %>%
    group_by( "Date Range" = wk_lbl) %>%
    summarise("Avg Sensor Reading" = paste(round(mean(sgv, na.rm=TRUE),1),"mg/dL"),
              "Std Deviation" = paste( round(sd(sgv, na.rm=TRUE),1),"mg/dL")
              ) %>%
    pander()

``` 

The blood glucose level for a non-diabetic is, on average, 100. This
shows us that even with insulin, Karen's averages are higher than a
non-diabetic. The weekly averages shown above are a little higher than
the report from February, but well within the range we would expect to
see based on the variance seen across weeks. The high weekly standard
deviation demonstrates that Karen experiences a wide range of blood
glucose levels. Although she does not meet the definition of a
"brittle diabetic", her blood glucose levels do swing dramatically as
a result of her
[gastroparesis](https://en.wikipedia.org/wiki/Gastroparesis), a
complication of diabetes.

# Number of Sensor Readings

The Statistics table does not include the number of sensor
readings. It only includes the number of manual blood glucose
readings, which cannot be directly replicated using CGM data. It is
surprising that the Medtronic report only includes the number and
daily average of manual tests. Knowing the number of sensor readings
is useful for understanding the consistency with which the CGM is
worn, whch is obviously important for assessing the accuracy and
validity of the CGM sensor data.

When the CGM is worn correctly and is operational, it records a new
reading every five minutes. But, Murphy rules. Batteries die, sensors
fall out and sensors lose their connection to the rig. In an ideal
world, the sensor will record 2,016 readings every week. As you can
see, the number of actual readings is usually below 2,000. When the
number of readings falls unexpectedly, such as the week starting on
July 19, it may indicate a problem with the CGM or how consistently
Karen is using the CGM.

```{r n-sensor-readings, echo=TRUE}

entries %>%
    filter( !is.na(wk_lbl) ) %>%
    group_by( "Date Range" = wk_lbl) %>%
    summarize("N Entries" = format( n(), big.mark="," ) ) %>%
    pander()

```

In this case, the low number of Nightscout readings is misleading. We
were in Ireland that week on vacation. Contrary to how it may appear,
Karen did continue to use her CGM that week, but there are significant
gaps because we suspended our use of the rig for several days that
week. We would like to thank Verizon for making it outrageously
complicated and expensive to set up and monitor a data connection in
Europe. THANK YOU!

# Time Spent Where

Duration matters. Karen's endocrinologist wants to know how much time
she spends in the "good" range, 70-140 mg/dL. In the Medtronic report,
these data elements are based on manual blood glucose tests, but we
can replicate them using Nightscout CGM data. The following table
shows the percentage of readings that are in the target range, above
it and below it.

```{r ranges-bg, echo=TRUE}

entries %>%
    filter( !is.na(wk_lbl) ) %>%
    group_by( "Date Range" = wk_lbl) %>%
    summarise("Sensor Readings" = n(),
              "Readings In Target Range " = paste( format(round(sum(ifelse(sgv >= 70 & sgv<= 140,1,0))/n()*100,2),
                                                          nsmall = 2),
                                                   "%", sep=""),
              "Readings Above Target" = paste( format(round(sum(ifelse(sgv > 140,1,0))/n()*100,2),
                                              nsmall = 2),
                                              "%",sep=""),
              "Readings Below Target" = paste( format(round(sum(ifelse(sgv < 70,1,0))/n()*100,2),
                                               nsmall=2),
                                               "%",sep="")
              ) %>%
    pander()

```

When worn regularly and correctly, CGM sensor data is not subject to
the measurement biases inherent in manual blood glucose tests which
could make CGM data a better source of this clinical
information. Karen is more likely to test when she believes she is
high or low, which can bias averages based on manual tests, even
though individually a manual test is more accurate than a CGM
reading. The next three sections look at Karen's CGM readings in these
three range groups more closely and include the average sensor values
in each range.

Although mathematically crude, simple proportions such as these are
clinically similar to the AUC and it is easier for many patients and
doctors to understand. By including the average sensor reading for
readings in a given range we can better understand the interplay
between duration and severity.

## Readings In Target Range

The first column is the total number of CGM readings which is the
denominator of the measure. The numerator, the number of readings in
the target range (70-140 mg/dL) is the second column. A diabetic wants
as many readings as possible to fall in this range. The last column is
the mean CGM value for readings in the target group. An average close
to 100 mg/dL is good.

```{r on-target, echo=TRUE}

entries %>%
    filter( !is.na(wk_lbl) ) %>%
    group_by( "Date Range" = wk_lbl) %>%
    summarise("CGM Readings" = n(),
              "Readings In Target Range" = sum(ifelse(sgv >= 70 & sgv<= 140,1,0)),
              "% In Target Range" = format(round(sum(ifelse(sgv >= 70 & sgv<= 140,1,0))/n()*100,2),
                                                  nsmall = 2
                                                  ),
              "CGM AVG" = paste( round(mean( ifelse(sgv >= 70 & sgv <= 140, sgv, NA), na.rm=TRUE),2),
                                "mg/dL",
                                sep=" "
                               )
              ) %>%
    pander()

```

On average, only a quarter of Karen's CGM readings fall within the
target range. Anything we can do to increase the number of readings in
the target range will improve Karen's control of her diabetes and help
prevent or limit future complications from diabetes. The raison d'être
of this project is to help Karen take corrective actions sooner, which
we believe can increase her blood glucose control. This is not a wild
hypothesis, Continuos Glucose Monitors were developed for the same
reason. It has been shown that diabetics using near-real-time
information to manage diabetes have better control of the
diabetes. Using this same data to make person-specific predictions is
the next step in developing a more comprehensive management system.

## Readings Above Target Range

The first column is the total number of CGM readings which is the
denominator of the measure. The second column shows the numerator, the
number of readings above the target range (140 mg/dL). A diabetic
wants to minimize the number of readings above 140 mg/dL. The last
column is the mean CGM value for readings above the target range. Time
spent above 140 mg/dL is damaging to the body. At extreme values,
hyperglycemia can result in diabetic ketoacidosis, coma and death. A
hyperglycemic average close to 140 is better than a higher average.

```{r above-target, echo=TRUE}

entries %>%
    filter( !is.na(wk_lbl) ) %>%
    group_by( "Date Range" = wk_lbl) %>%
    summarise("CGM Readings" = n(),
              "Readings Above Target" = sum(ifelse(sgv > 140,1,0)),
              "% Above Target" = paste(format(round(sum(ifelse(sgv > 140,1,0))/n()*100,2),
                                              nsmall = 2),
                                       "%"),
              "CGM AVG" = paste( format(round(mean( ifelse(sgv > 140, sgv, NA), na.rm=TRUE),2),nsmall=2), " mg/dL")
              ) %>%
    pander()

```

Karen is hyperglycemic more often than we would like. And when she is
hyperglycemic, these episodes are moderately severe and tend to last
several hours If we can predict the onset of these hyperglycemic
episodes before they begin, we may be able to increase the amount of
time she spends in the desired range by taking corrective action
before she is hyperglycemic.

## Readings Below Target Range

The first column is the total number of CGM readings which is the
denominator of the measure. The second column shows the numerator, the
number of readings below the target range (70 mg/dL). A diabetic wants
to minimize the number of readings below the target range. When below
70 mg/dL diabetics experience confusion and anxiety. More severe lows
can result in losing consciousness or even entering a diabetic
coma. The last column is the mean CGM value for readings below the
target range. A hypoglycemic average close to 70 is better than a
lower average.

```{r below-target, echo=TRUE}

entries %>%
    filter( !is.na(wk_lbl) ) %>%
    group_by( "Date Range" = wk_lbl) %>%
    summarise("CGM Readings" = n(),
              "Readings Below Target" = sum(ifelse(sgv < 70,1,0)),
              "% Below Target" = format(round(sum(ifelse(sgv < 70,1,0))/n()*100,2),
                                                  nsmall = 2
                                                  ),
              "BG AVG" = paste( format( round( mean( ifelse(sgv < 70, sgv, NA), na.rm=TRUE), 2),
                                        nsmall=2
                                      ),
                                "mg/dL",
                                sep=" "
                              )
              ) %>%
    pander()

```

Although the amount of time spent below 70 is small, Karen's
hypoglycemic episodes can be severe. Karen's hyperglycemic episodes
are often followed by a hard blood glucose level crash. These crashes
can ruin her entire afternoon and at their worst, can be
dangerous. Limiting the severity of these attacks would improve her
quality of life and safety. If we can reduce the number of
hyperglycemic episodes, we will also reduce the number of these hard
crashes.

Karen copes with these hypoglycemic episodes remarkably well. A blood
glucose level of 40 mg/dL for a non-diabetic would be profoundly
disabling. In the 10+ years I have known her, Karen has never lost
consciousness due to a hypoglycemic episode. She is apparently made of
adamantium.
